<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.2 Documentation: Iterative Graph Processing</title>
    <link rel="shortcut icon" href="/1.2.0/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/1.2.0/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="/1.2.0/page/css/flink.css">
    <link rel="stylesheet" href="/1.2.0/page/css/syntax.css">
    <link rel="stylesheet" href="/1.2.0/page/css/codetabs.css">
    <link rel="stylesheet" href="/1.2.0/page/font-awesome/css/font-awesome.min.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    
    

    <!-- Main content. -->
    <div class="container">
      
      <div class="row">
        <div class="col-lg-3">
          







  
    
    
    
      
    
  

  
    
    
    
      
    
  

  
    
    
    
      
    
  

  
    
    
    
      









  





<div class="sidenav-logo">
  <p><a href="/1.2.0"><img class="bottom" alt="Apache Flink" src="/1.2.0/page/img/navbar-brand-logo.jpg"></a> v1.2</p>
</div>
<ul id="sidenav">

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/index.html"><i class="fa fa-home title" aria-hidden="true"></i> 首页</a></li>
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-2" data-toggle="collapse"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i> 概念 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-2"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/1.2.0/concepts/programming-model.html">编程模型</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/concepts/runtime.html">Distributed Runtime</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/quickstart/setup_quickstart.html"><i class="fa fa-power-off title appetizer" aria-hidden="true"></i> 快速起步</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-7" data-toggle="collapse"><i class="fa fa-file-code-o title appetizer" aria-hidden="true"></i> 示例 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-7"><ul>
  <li><a href="/1.2.0/examples/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/quickstart/run_example_quickstart.html">Monitoring Wikipedia Edits</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/examples.html">Batch Examples</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-11" data-toggle="collapse"><i class="fa fa-cogs title maindish" aria-hidden="true"></i> 建立工程 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-11"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/quickstart/java_api_quickstart.html">Java 的样例工程</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/quickstart/scala_api_quickstart.html">Scala 的样例工程</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/linking_with_flink.html">Linking with Flink</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/ide_setup.html">IDE Setup</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/scala_shell.html">Scala REPL</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/linking.html">关联可选模块</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/flink_on_windows.html">Running Flink on Windows</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/building.html">Building Flink from Source</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-21" data-toggle="collapse" class="active"><i class="fa fa-code title maindish" aria-hidden="true"></i> 应用开发</a><div class="collapse in" id="collapse-21"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-22" data-toggle="collapse">Basic API Concepts <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-22"><ul>
  <li><a href="/1.2.0/dev/api_concepts.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/scala_api_extensions.html">Scala API Extensions</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/java8.html">Java 8</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-26" data-toggle="collapse">Streaming (DataStream API) <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-26"><ul>
  <li><a href="/1.2.0/dev/datastream_api.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/1.2.0/dev/windows.html">Windows</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-28" data-toggle="collapse">Event Time <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-28"><ul>
  <li><a href="/1.2.0/dev/event_time.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/event_timestamps_watermarks.html">Generating Timestamps / Watermarks</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/event_timestamp_extractors.html">预定义的 Timestamp Extractors / Watermark Emitters</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-32" data-toggle="collapse">Connectors <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-32"><ul>
  <li><a href="/1.2.0/dev/connectors/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/guarantees.html">Fault Tolerance Guarantees</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/kafka.html">Kafka</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/cassandra.html">Cassandra</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/kinesis.html">Kinesis</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/elasticsearch.html">Elasticsearch</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/filesystem_sink.html">Rolling File Sink</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/rabbitmq.html">RabbitMQ</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/nifi.html">NiFi</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/connectors/twitter.html">Twitter</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/process_function.html">过程函数</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/side_output.html">Side Outputs</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/state.html">Working with State</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/checkpointing.html">Checkpointing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/asyncio.html">Async I/O</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/stream/queryable_state.html">Queryable State</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-50" data-toggle="collapse">批 (DataSet API) <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-50"><ul>
  <li><a href="/1.2.0/dev/batch/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/dataset_transformations.html">Transformations</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/iterations.html">Iterations</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/zip_elements_guide.html">Zipping Elements</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/fault_tolerance.html">Fault Tolerance</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/python.html">Python API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/connectors.html">Connectors</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/batch/hadoop_compatibility.html">Hadoop Compatibility</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/local_execution.html">Local Execution</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/cluster_execution.html">Cluster Execution</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-61" data-toggle="collapse">数据类型和序列化 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-61"><ul>
  <li><a href="/1.2.0/dev/types_serialization.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/custom_serializers.html">Custom Serializers</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-64" data-toggle="collapse">Managing Execution <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-64"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/execution_configuration.html">Execution Configuration</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/packaging.html">Program Packaging</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/parallel.html">并行执行</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/execution_plans.html">执行计划</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/restart_strategies.html">Restart Strategies</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-71" data-toggle="collapse" class="active">Libraries</a><div class="collapse in" id="collapse-71"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/table_api.html">Table and SQL</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/cep.html">Event Processing (CEP)</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/storm_compatibility.html">Storm Compatibility</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-75" data-toggle="collapse" class="active">Graphs: Gelly</a><div class="collapse in" id="collapse-75"><ul>
  <li><a href="/1.2.0/dev/libs/gelly/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/graph_api.html">Graph API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/iterative_graph_processing.html" class="active">Iterative Graph Processing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/library_methods.html">Library Methods</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/graph_algorithms.html">Graph Algorithms</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/graph_generators.html">Graph Generators</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/gelly/bipartite_graph.html">Bipartite Graph</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-83" data-toggle="collapse">机器学习 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-83"><ul>
  <li><a href="/1.2.0/dev/libs/ml/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/quickstart.html">快速入门</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/multiple_linear_regression.html">多元线性回归</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/cross_validation.html">交叉验证</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/distance_metrics.html">距离度量</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/knn.html">K近邻算法（KNN）</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/min_max_scaler.html">最小最大值标准化</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/contribution_guide.html">贡献指南</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/pipelines.html">Pipelines</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/polynomial_features.html">多项式特征转换</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/als.html">ALS</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/sos.html">Stochastic Outlier Selection</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/standard_scaler.html">标准化缩放</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/libs/ml/svm.html">支持向量机（SVM using CoCoA）</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/best_practices.html">Best Practices</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/dev/migration.html">API Migration Guides</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-102" data-toggle="collapse"><i class="fa fa-sliders title maindish" aria-hidden="true"></i> 部署与运维 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-102"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/1.2.0/setup/config.html">Configuration</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/cli.html">CLI</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-105" data-toggle="collapse">Clusters & Deployment <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-105"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/cluster_setup.html">Standalone Cluster</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/yarn_setup.html">YARN</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/mesos.html">Mesos</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/aws.html">AWS</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/gce_setup.html">Google Compute Engine</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/mapr_setup.html">MapR</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/jobmanager_high_availability.html">High Availability (HA)</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/checkpoints.html">Checkpoints</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/savepoints.html">Savepoints</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/setup/security-ssl.html">SSL Setup</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/ops/security-kerberos.html">Kerberos</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/ops/upgrading.html">Upgrading Applications and Flink Versions</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/ops/production_ready.html">生产环境检查清单</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-121" data-toggle="collapse"><i class="fa fa-bug title maindish" aria-hidden="true"></i> 调试与监控 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-121"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/metrics.html">Metrics</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/logging.html">Logging</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/historyserver.html">History Server</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/checkpoint_monitoring.html">Monitoring Checkpointing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/back_pressure.html">Monitoring Back Pressure</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/rest_api.html">Monitoring REST API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/large_state_tuning.html">Debugging and Tuning Checkpoints and Large State</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/debugging_event_time.html">Debugging Windows & Event Time</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/debugging_classloading.html">Debugging Classloading</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/monitoring/application_profiling.html">Application Profiling</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-133" data-toggle="collapse"><i class="fa fa-book title dessert" aria-hidden="true"></i> 内部原理 <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-133"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/components.html">Component Stack</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/stream_checkpointing.html">Fault Tolerance for Data Streaming</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/job_scheduling.html">Jobs and Scheduling</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/task_lifecycle.html">Task Lifecycle</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/1.2.0/internals/filesystems.html">File Systems</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
<li><a href="/1.2.0/about/index.html"><i class="fa fa-fire title hot" aria-hidden="true"></i> 参与贡献</a></li>
    
  

  
    
      
  <li class="divider"></li>
  <li><a href="http://flink-china.org"><i class="fa fa-external-link title" aria-hidden="true"></i> 项目页面</a></li>
</ul>

<div class="sidenav-search-box">
  <form class="navbar-form" role="search" action="/1.2.0/search-results.html">
    <div class="form-group">
      <input type="text" class="form-control" size="16px" name="q" placeholder="搜索文档">
    </div>
    <button type="submit" class="btn btn-default">搜索</button>
  </form>
</div>

<div class="sidenav-versions">
  <div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">选择文档版本
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
      
      <li><a href="http://doc.flink-china.org/1.1.0/">v1.1</a></li>
      
    </ul>
  </div>
</div>

        </div>
        <div class="col-lg-9 content">
          

          





  
  
    
    
      
    
  

  
  
    
    
      
    
  

  
  
    
    
      
    
  

  
  
    
    
      



<ol class="breadcrumb">

  
  
    <li><i class="fa fa-code title maindish" aria-hidden="true"></i> 应用开发</li>
  

  
  
    <li>Libraries</li>
  

  
  
    <li><a href="/1.2.0/dev/libs/gelly/index.html">Graphs: Gelly</a></li>
  

  
  
    <li class="active">Iterative Graph Processing</li>
  

</ol>

<h1>Iterative Graph Processing</h1>



<p>Gelly利用了Flink的高效迭代操作以支持大型迭代图计算。目前我们提供了Vertex Centric，Scatter Gather和Gather Sum Apply模型的实现。接下来的章节中，我们描述了这些抽象并展示了如何在Gelly中使用它们。</p>

<ul id="markdown-toc">
  <li><a href="#vertex-centric" id="markdown-toc-vertex-centric">Vertex Centric迭代计算</a></li>
  <li><a href="#vertex-centric-1" id="markdown-toc-vertex-centric-1">Vertex Centric迭代计算配置</a></li>
  <li><a href="#scatter-gather" id="markdown-toc-scatter-gather">Scatter Gather迭代计算</a></li>
  <li><a href="#scatter-gather-1" id="markdown-toc-scatter-gather-1">Scatter Gather迭代计算配置</a></li>
  <li><a href="#gather-sum-apply" id="markdown-toc-gather-sum-apply">Gather Sum Apply迭代计算</a></li>
  <li><a href="#gather-sum-apply-1" id="markdown-toc-gather-sum-apply-1">Gather Sum Apply迭代计算配置</a></li>
  <li><a href="#section" id="markdown-toc-section">迭代计算抽象对比</a></li>
</ul>

<h2 id="vertex-centric">Vertex Centric迭代计算</h2>
<p>Vertex Centric模型，也称为”像顶点一样思考”或”Pregel”，通过图顶点的角度表达计算。
该计算在迭代的每一步（称为超步）中同步地处理，在每个超步时，每个顶点执行一个UDF（User Defined Function）。
顶点之间通过消息进行通讯，任何一个顶点可以给图中任何其他的顶点发送消息，只要知道它的ID即可。</p>

<p>下面的图中展示该计算模型，虚线框和并行单元对应。在每个超步中，所有的活跃顶点并行执行相同的用户定义的计算。因为超步时同步执行的，因此每次超步中发送的消息都被保证发送了到下次超步的开始。</p>

<p class="text-center">
    <img alt="Vertex-Centric Computational Model" width="70%" src="/1.2.0/fig/vertex-centric supersteps.png" />
</p>

<p>在Gelly中使用Vertex Centric迭代，用户只需要定义顶点的计算函数<code>ComputeFunction</code>即可。</p>

<p>该函数和最大迭代次数通过Gelly的<code>runVertexCentricIteration</code>函数参数指定。该方法在输入图上执行Vertex Centric迭代计算，并输出更新后顶点值的新图。可选的<code>MessageCombiner</code>函数可以被用于减少通信消耗。</p>

<p>让我们考虑基于Vertex Centric的单源点最短路径算法（SSSP）。算法开始时，除了源顶点初始值为0，每个顶点初始值为正无穷。第一次超步计算时，源顶点将距离传播给它的邻居。在接下来的超步中，每个顶点检查接收的消息并选择其中最小的距离值。如果该距离值比顶点当前值小，则更新顶点的值，并产生消息发送给其邻居。如果顶点在超步中没有更新它的值，则在下次超步时不会发送任何消息给它的邻居。当没有顶点的值发生更新或者达到了最大的超步迭代次数，算法将会收敛。在这个算法中，Message Combiner可以被用来减少发送给目标顶点的消息个数。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// read the input graph</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="kt">int</span> <span class="n">maxIterations</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="c1">// Execute the vertex-centric iteration</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">runVertexCentricIteration</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">SSSPComputeFunction</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">SSSPCombiner</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">);</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">singleSourceShortestPaths</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getVertices</span><span class="o">();</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SSSPComputeFunction</span> <span class="kd">extends</span> <span class="n">ComputeFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">(</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">vertex</span><span class="o">,</span> <span class="n">MessageIterator</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">double</span> <span class="n">minDistance</span> <span class="o">=</span> <span class="o">(</span><span class="n">vertex</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">srcId</span><span class="o">))</span> <span class="o">?</span> <span class="mi">0</span><span class="n">d</span> <span class="o">:</span> <span class="n">Double</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span><span class="o">;</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Double</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">minDistance</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">minDistance</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">minDistance</span> <span class="o">&lt;</span> <span class="n">vertex</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">setNewVertexValue</span><span class="o">(</span><span class="n">minDistance</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Edge</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="nl">e:</span> <span class="n">getEdges</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sendMessageTo</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTarget</span><span class="o">(),</span> <span class="n">minDistance</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// message combiner</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SSSPCombiner</span> <span class="kd">extends</span> <span class="n">MessageCombiner</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">combineMessages</span><span class="o">(</span><span class="n">MessageIterator</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">double</span> <span class="n">minMessage</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Double</span> <span class="nl">msg:</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">minMessage</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">minMessage</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sendCombinedMessage</span><span class="o">(</span><span class="n">minMessage</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// read the input graph</span>
<span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="k">val</span> <span class="n">maxIterations</span> <span class="k">=</span> <span class="mi">10</span>

<span class="c1">// Execute the vertex-centric iteration</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runVertexCentricIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">SSSPComputeFunction</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SSSPCombiner</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">)</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="k">val</span> <span class="n">singleSourceShortestPaths</span> <span class="k">=</span> <span class="n">result</span><span class="o">.</span><span class="n">getVertices</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">SSSPComputeFunction</span> <span class="k">extends</span> <span class="nc">ComputeFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span><span class="o">(</span><span class="n">vertex</span><span class="k">:</span> <span class="kt">Vertex</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">],</span> <span class="n">messages</span><span class="k">:</span> <span class="kt">MessageIterator</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">minDistance</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">vertex</span><span class="o">.</span><span class="n">getId</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="n">srcId</span><span class="o">))</span> <span class="mi">0</span> <span class="k">else</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">MaxValue</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">next</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">minDistance</span> <span class="k">=</span> <span class="n">msg</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">vertex</span><span class="o">.</span><span class="n">getValue</span> <span class="o">&gt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNewVertexValue</span><span class="o">(</span><span class="n">minDistance</span><span class="o">)</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">edge</span><span class="k">:</span> <span class="kt">Edge</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">&lt;-</span> <span class="n">getEdges</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sendMessageTo</span><span class="o">(</span><span class="n">edge</span><span class="o">.</span><span class="n">getTarget</span><span class="o">,</span> <span class="n">vertex</span><span class="o">.</span><span class="n">getValue</span> <span class="o">+</span> <span class="n">edge</span><span class="o">.</span><span class="n">getValue</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// message combiner</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">SSSPCombiner</span> <span class="k">extends</span> <span class="nc">MessageCombiner</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">combineMessages</span><span class="o">(</span><span class="n">messages</span><span class="k">:</span> <span class="kt">MessageIterator</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span> <span class="o">{</span>

        <span class="k">var</span> <span class="n">minDistance</span> <span class="k">=</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">MaxValue</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="n">inMessages</span><span class="o">.</span><span class="n">next</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">minDistance</span> <span class="k">=</span> <span class="n">msg</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sendCombinedMessage</span><span class="o">(</span><span class="n">minMessage</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="vertex-centric-1">Vertex Centric迭代计算配置</h2>
<p>Vertex Centric迭代计算可以使用<code>VertexCentricConfiguration</code>对象进行配置。</p>

<p>目前有如下参数可以指定：</p>

<ul>
  <li>
    <p><strong>名称</strong>: Vertex Centric迭代计算的名称，该名称在日志和消息中显示，并可以使用<code>setName()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>并行度</strong>: 迭代计算的并行度，可以使用<code>setParallelism()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>堆内Solution Set</strong>: 定义了Solution Set是否保存在堆内内存（Flink内部对象的序列化方式）中，还是保存在简单的对象表中。默认情况下，Solution Set保存在堆内内存中，该属性可以通过<code>setSolutionSetUnmanagedMemory()</code>方法进行设置。</p>
  </li>
  <li>
    <p><strong>聚合器</strong>: 迭代聚合器可以使用<code>registerAggregator()</code>方法进行注册，迭代聚合器可以将每次超步的聚合结果合并起来，并使得在下次超步中可以访问它们。注册后的聚合器可以在用户定义的<code>ComputeFunction</code>的内部进行访问。</p>
  </li>
  <li>
    <p><strong>广播变量</strong>: 可以使用<code>addBroadcastSet()</code>方法将数据集作为<a href="/1.2.0/dev/batch/index.html#broadcast-variables">广播变量</a>添加到<code>ComputeFunction</code>。</p>
  </li>
</ul>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">VertexCentricConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">VertexCentricConfiguration</span><span class="o">();</span>

<span class="c1">// set the iteration name</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Gelly Iteration&quot;</span><span class="o">);</span>

<span class="c1">// set the parallelism</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setParallelism</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>

<span class="c1">// register an aggregator</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">registerAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nf">LongSumAggregator</span><span class="o">());</span>

<span class="c1">// run the vertex-centric iteration, also passing the configuration parameters</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
            <span class="n">graph</span><span class="o">.</span><span class="na">runVertexCentricIteration</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">Compute</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>

<span class="c1">// user-defined function</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Compute</span> <span class="kd">extends</span> <span class="n">ComputeFunction</span> <span class="o">{</span>

    <span class="n">LongSumAggregator</span> <span class="n">aggregator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">LongSumAggregator</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preSuperstep</span><span class="o">()</span> <span class="o">{</span>

        <span class="c1">// retrieve the Aggregator</span>
        <span class="n">aggregator</span> <span class="o">=</span> <span class="n">getIterationAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">(</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">vertex</span><span class="o">,</span> <span class="n">MessageIterator</span> <span class="n">inMessages</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//do some computation</span>
        <span class="n">Long</span> <span class="n">partialValue</span> <span class="o">=</span> <span class="o">...</span>

        <span class="c1">// aggregate the partial value</span>
        <span class="n">aggregator</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">partialValue</span><span class="o">);</span>

        <span class="c1">// update the vertex value</span>
        <span class="n">setNewVertexValue</span><span class="o">(...);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Long</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">VertexCentricConfiguration</span>

<span class="c1">// set the iteration name</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setName</span><span class="o">(</span><span class="s">&quot;Gelly Iteration&quot;</span><span class="o">)</span>

<span class="c1">// set the parallelism</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setParallelism</span><span class="o">(</span><span class="mi">16</span><span class="o">)</span>

<span class="c1">// register an aggregator</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">registerAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LongSumAggregator</span><span class="o">)</span>

<span class="c1">// run the vertex-centric iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runVertexCentricIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Compute</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Combiner</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>

<span class="c1">// user-defined function</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Compute</span> <span class="k">extends</span> <span class="nc">ComputeFunction</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">aggregator</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongSumAggregator</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">preSuperstep</span> <span class="o">{</span>

        <span class="c1">// retrieve the Aggregator</span>
        <span class="n">aggregator</span> <span class="k">=</span> <span class="n">getIterationAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">)</span>
    <span class="o">}</span>


    <span class="k">override</span> <span class="k">def</span> <span class="n">compute</span><span class="o">(</span><span class="n">vertex</span><span class="k">:</span> <span class="kt">Vertex</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Long</span><span class="o">],</span> <span class="n">inMessages</span><span class="k">:</span> <span class="kt">MessageIterator</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span> <span class="o">{</span>

        <span class="c1">//do some computation</span>
        <span class="k">val</span> <span class="n">partialValue</span> <span class="k">=</span> <span class="o">...</span>

        <span class="c1">// aggregate the partial value</span>
        <span class="n">aggregator</span><span class="o">.</span><span class="n">aggregate</span><span class="o">(</span><span class="n">partialValue</span><span class="o">)</span>

        <span class="c1">// update the vertex value</span>
        <span class="n">setNewVertexValue</span><span class="o">(...)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="scatter-gather">Scatter Gather迭代计算</h2>
<p>Scatter Gather模型，也称为”signal/collect”模型，通过图顶点的角度表达计算。该计算在迭代的每一步（称为超步）中同步地处理，在每个超步时，每个顶点为其他顶点产生消息，并基于它接受到的消息更新自己的值。在Gelly使用Scatter Gather迭代计算，用户只需要定义每次超步中每个顶点的行为即可：</p>

<ul>
  <li><strong>Scatter</strong>: 产生一个顶点发送给其他顶点的消息。</li>
  <li><strong>Gather</strong>: 使用接收到的消息更新顶点的值。</li>
</ul>

<p>Gelly为Scatter Gather迭代计算提供了方法，用户只需要实现两个函数，与scatter和gather阶段相对应。第一个函数是<code>ScatterFunction</code>，它允许顶点向其他顶点发送消息，消息将会在它们被发送所在的超步时被接收。第二个函数是<code>GatherFunction</code>，它定义了顶点如何基于接收到的消息更新自己的值。</p>

<p>这些函数和最大迭代次数通过Gelly的<code>runScatterGatherIteration</code>函数参数指定。该方法在输入图上执行Vertex Centric迭代计算，并输出更新后顶点值的新图。</p>

<p>一次Scatter Gather迭代可以使用类如总顶点数、入度和出度等信息进行扩展。</p>

<p>另外，Scatter Gather迭代运行使用的邻居类型(in/out/all)也可以被指定。默认情况下，来自输入邻居的更新将会修改当前顶点的状态，而消息将发送给输出的邻居。</p>

<p>让我们考虑使用Scatter Gather迭代模型计算单源点最短路径的算法（SSSP），下面的图中顶点1是原点。每次超步中，每个顶点发送候选的距离消息到它的邻居，消息的值是当前顶点值与连接到该顶点的边的权值之和。当收到候选的距离消息时，每个顶点计算最小的距离，如果更短的路径被计算出来，顶点的值就会被更新。如果顶点在超步中没有更改它的值，那么它就不会产生下次超步中发送给邻居的消息。该算法在没有顶点值更新时收敛。</p>

<p class="text-center">
    <img alt="Scatter-gather SSSP superstep 1" width="70%" src="/1.2.0/fig/gelly-vc-sssp1.png" />
</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// read the input graph</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="kt">int</span> <span class="n">maxIterations</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="c1">// Execute the scatter-gather iteration</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">runScatterGatherIteration</span><span class="o">(</span>
			<span class="k">new</span> <span class="nf">MinDistanceMessenger</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">VertexDistanceUpdater</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">);</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">singleSourceShortestPaths</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getVertices</span><span class="o">();</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="c1">// scatter: messaging</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MinDistanceMessenger</span> <span class="kd">extends</span> <span class="n">ScatterFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessages</span><span class="o">(</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">vertex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Edge</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">getEdges</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">sendMessageTo</span><span class="o">(</span><span class="n">edge</span><span class="o">.</span><span class="na">getTarget</span><span class="o">(),</span> <span class="n">vertex</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="n">edge</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// gather: vertex update</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">VertexDistanceUpdater</span> <span class="kd">extends</span> <span class="n">GatherFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateVertex</span><span class="o">(</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">vertex</span><span class="o">,</span> <span class="n">MessageIterator</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">inMessages</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Double</span> <span class="n">minDistance</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">inMessages</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">minDistance</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">vertex</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setNewVertexValue</span><span class="o">(</span><span class="n">minDistance</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// read the input graph</span>
<span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="k">val</span> <span class="n">maxIterations</span> <span class="k">=</span> <span class="mi">10</span>

<span class="c1">// Execute the scatter-gather iteration</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runScatterGatherIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">MinDistanceMessenger</span><span class="o">,</span> <span class="k">new</span> <span class="nc">VertexDistanceUpdater</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">)</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="k">val</span> <span class="n">singleSourceShortestPaths</span> <span class="k">=</span> <span class="n">result</span><span class="o">.</span><span class="n">getVertices</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="c1">// messaging</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">MinDistanceMessenger</span> <span class="k">extends</span> <span class="nc">ScatterFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">sendMessages</span><span class="o">(</span><span class="n">vertex</span><span class="k">:</span> <span class="kt">Vertex</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">edge</span><span class="k">:</span> <span class="kt">Edge</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">&lt;-</span> <span class="n">getEdges</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">sendMessageTo</span><span class="o">(</span><span class="n">edge</span><span class="o">.</span><span class="n">getTarget</span><span class="o">,</span> <span class="n">vertex</span><span class="o">.</span><span class="n">getValue</span> <span class="o">+</span> <span class="n">edge</span><span class="o">.</span><span class="n">getValue</span><span class="o">)</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// vertex update</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">VertexDistanceUpdater</span> <span class="k">extends</span> <span class="nc">GatherFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">updateVertex</span><span class="o">(</span><span class="n">vertex</span><span class="k">:</span> <span class="kt">Vertex</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span><span class="o">],</span> <span class="n">inMessages</span><span class="k">:</span> <span class="kt">MessageIterator</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
		<span class="k">var</span> <span class="n">minDistance</span> <span class="k">=</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">MaxValue</span>

		<span class="k">while</span> <span class="o">(</span><span class="n">inMessages</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
		  <span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="n">inMessages</span><span class="o">.</span><span class="n">next</span>
		  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">minDistance</span> <span class="k">=</span> <span class="n">msg</span>
		  <span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">vertex</span><span class="o">.</span><span class="n">getValue</span> <span class="o">&gt;</span> <span class="n">minDistance</span><span class="o">)</span> <span class="o">{</span>
		  <span class="n">setNewVertexValue</span><span class="o">(</span><span class="n">minDistance</span><span class="o">)</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="scatter-gather-1">Scatter Gather迭代计算配置</h2>

<p>Scatter Gather迭代可以使用<code>ScatterGatherConfiguration</code>对象进行配置。</p>

<p>目前有以下参数可以被指定：</p>

<ul>
  <li>
    <p><strong>名称</strong>: Scatter Gather迭代计算的名称，该名称在日志和消息中显示，并可以使用<code>setName()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>并行度</strong>: 迭代计算的并行度，可以使用<code>setParallelism()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>堆内Solution Set</strong>: 定义了Solution Set是否保存在堆内内存（Flink内部对象的序列化方式）中，还是保存在简单的对象表中。默认情况下，Solution Set保存在堆内内存中，该属性可以通过<code>setSolutionSetUnmanagedMemory()</code>方法进行设置。</p>
  </li>
  <li>
    <p><strong>聚合器</strong>: 迭代聚合器可以使用<code>registerAggregator()</code>方法进行注册，迭代聚合器可以将每次超步的聚合结果合并起来，并使得在下次超步中可以访问它们。注册后的聚合器可以在用户定义的<code>ScatterFunction</code>和<code>GatherFunction</code>的内部进行访问。</p>
  </li>
  <li>
    <p><strong>广播变量</strong>: 可以分别使用<code>addBroadcastSetForUpdateFunction()</code>和<code>addBroadcastSetForMessagingFunction()</code>方法将数据集作为<a href="/1.2.0/dev/batch/index.html#broadcast-variables">广播变量</a>添加到<code>ScatterFunction</code>和<code>GatherFunction</code>。</p>
  </li>
  <li>
    <p><strong>顶点数</strong>: 允许迭代内部访问顶点总数，该属性可以通过<code>setOptNumVertices()</code>方法设置。</p>
  </li>
</ul>

<p>在顶点更新函数和消息传播函数内可以使用<code>getNumberOfVertices()</code>函数访问顶点数。如果该选型未设置，方法返回-1。</p>

<ul>
  <li><strong>度</strong>: 允许迭代内部访问顶点的出度或入度，该属性可以通过<code>setOptDegrees()</code>方法设置。</li>
</ul>

<p>在scatter和gather函数内可以使用<code>getInDegree()</code>和<code>getInDegree()</code>函数访问顶点的入度和出度。如果度选项未设置，方法返回-1。</p>

<ul>
  <li><strong>消息传播方向</strong>: 默认情况下，顶点发送消息给它的邻居，并基于从邻居接收到的消息更新自身的值。该配置选项允许用户更改消息传播的方向，取值EdgeDirection.IN<code>，</code>EdgeDirection.OUT<code>和</code>EdgeDirection.ALL<code>。相应地，消息传播方向决定了更新接受消息的方向为</code>EdgeDirection.OUT<code>，</code>EdgeDirection.IN<code>和</code>EdgeDirection.ALL<code>。该属性可以通过</code>setDirection()`方法进行设置。</li>
</ul>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">ScatterGatherConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ScatterGatherConfiguration</span><span class="o">();</span>

<span class="c1">// set the iteration name</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Gelly Iteration&quot;</span><span class="o">);</span>

<span class="c1">// set the parallelism</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setParallelism</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>

<span class="c1">// register an aggregator</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">registerAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nf">LongSumAggregator</span><span class="o">());</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
			<span class="n">graph</span><span class="o">.</span><span class="na">runScatterGatherIteration</span><span class="o">(</span>
			<span class="k">new</span> <span class="nf">Messenger</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">VertexUpdater</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>

<span class="c1">// user-defined functions</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Messenger</span> <span class="kd">extends</span> <span class="n">ScatterFunction</span> <span class="o">{...}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">VertexUpdater</span> <span class="kd">extends</span> <span class="n">GatherFunction</span> <span class="o">{</span>

	<span class="n">LongSumAggregator</span> <span class="n">aggregator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">LongSumAggregator</span><span class="o">();</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preSuperstep</span><span class="o">()</span> <span class="o">{</span>

		<span class="c1">// retrieve the Aggregator</span>
		<span class="n">aggregator</span> <span class="o">=</span> <span class="n">getIterationAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">);</span>
	<span class="o">}</span>


	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateVertex</span><span class="o">(</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">vertex</span><span class="o">,</span> <span class="n">MessageIterator</span> <span class="n">inMessages</span><span class="o">)</span> <span class="o">{</span>

		<span class="c1">//do some computation</span>
		<span class="n">Long</span> <span class="n">partialValue</span> <span class="o">=</span> <span class="o">...</span>

		<span class="c1">// aggregate the partial value</span>
		<span class="n">aggregator</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">partialValue</span><span class="o">);</span>

		<span class="c1">// update the vertex value</span>
		<span class="n">setNewVertexValue</span><span class="o">(...);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ScatterGatherConfiguration</span>

<span class="c1">// set the iteration name</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setName</span><span class="o">(</span><span class="s">&quot;Gelly Iteration&quot;</span><span class="o">)</span>

<span class="c1">// set the parallelism</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setParallelism</span><span class="o">(</span><span class="mi">16</span><span class="o">)</span>

<span class="c1">// register an aggregator</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">registerAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LongSumAggregator</span><span class="o">)</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runScatterGatherIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Messenger</span><span class="o">,</span> <span class="k">new</span> <span class="nc">VertexUpdater</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>

<span class="c1">// user-defined functions</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Messenger</span> <span class="k">extends</span> <span class="nc">ScatterFunction</span> <span class="o">{...}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">VertexUpdater</span> <span class="k">extends</span> <span class="nc">GatherFunction</span> <span class="o">{</span>

	<span class="k">var</span> <span class="n">aggregator</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LongSumAggregator</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">preSuperstep</span> <span class="o">{</span>

		<span class="c1">// retrieve the Aggregator</span>
		<span class="n">aggregator</span> <span class="k">=</span> <span class="n">getIterationAggregator</span><span class="o">(</span><span class="s">&quot;sumAggregator&quot;</span><span class="o">)</span>
	<span class="o">}</span>


	<span class="k">override</span> <span class="k">def</span> <span class="n">updateVertex</span><span class="o">(</span><span class="n">vertex</span><span class="k">:</span> <span class="kt">Vertex</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Long</span><span class="o">],</span> <span class="n">inMessages</span><span class="k">:</span> <span class="kt">MessageIterator</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span> <span class="o">{</span>

		<span class="c1">//do some computation</span>
		<span class="k">val</span> <span class="n">partialValue</span> <span class="k">=</span> <span class="o">...</span>

		<span class="c1">// aggregate the partial value</span>
		<span class="n">aggregator</span><span class="o">.</span><span class="n">aggregate</span><span class="o">(</span><span class="n">partialValue</span><span class="o">)</span>

		<span class="c1">// update the vertex value</span>
		<span class="n">setNewVertexValue</span><span class="o">(...)</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p>下面的例子展示了度数和顶点数选项的使用。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">ScatterGatherConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ScatterGatherConfiguration</span><span class="o">();</span>

<span class="c1">// set the number of vertices option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setOptNumVertices</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="c1">// set the degree option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setOptDegrees</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
			<span class="n">graph</span><span class="o">.</span><span class="na">runScatterGatherIteration</span><span class="o">(</span>
			<span class="k">new</span> <span class="nf">Messenger</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">VertexUpdater</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>

<span class="c1">// user-defined functions</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Messenger</span> <span class="kd">extends</span> <span class="n">ScatterFunction</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// retrieve the vertex out-degree</span>
	<span class="n">outDegree</span> <span class="o">=</span> <span class="n">getOutDegree</span><span class="o">();</span>
	<span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">VertexUpdater</span> <span class="kd">extends</span> <span class="n">GatherFunction</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// get the number of vertices</span>
	<span class="kt">long</span> <span class="n">numVertices</span> <span class="o">=</span> <span class="n">getNumberOfVertices</span><span class="o">();</span>
	<span class="o">...</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ScatterGatherConfiguration</span>

<span class="c1">// set the number of vertices option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setOptNumVertices</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>

<span class="c1">// set the degree option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setOptDegrees</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runScatterGatherIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Messenger</span><span class="o">,</span> <span class="k">new</span> <span class="nc">VertexUpdater</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>

<span class="c1">// user-defined functions</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Messenger</span> <span class="k">extends</span> <span class="nc">ScatterFunction</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// retrieve the vertex out-degree</span>
	<span class="k">val</span> <span class="n">outDegree</span> <span class="k">=</span> <span class="n">getOutDegree</span>
	<span class="o">...</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">VertexUpdater</span> <span class="k">extends</span> <span class="nc">GatherFunction</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// get the number of vertices</span>
	<span class="k">val</span> <span class="n">numVertices</span> <span class="k">=</span> <span class="n">getNumberOfVertices</span>
	<span class="o">...</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p>下面的例子展示了边方向选项的使用，顶点更新的值包含它的输入邻居列表。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">ScatterGatherConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ScatterGatherConfiguration</span><span class="o">();</span>

<span class="c1">// set the messaging direction</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setDirection</span><span class="o">(</span><span class="n">EdgeDirection</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span>
			<span class="n">graph</span><span class="o">.</span><span class="na">runScatterGatherIteration</span><span class="o">(</span>
			<span class="k">new</span> <span class="nf">Messenger</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">VertexUpdater</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>
			<span class="o">.</span><span class="na">getVertices</span><span class="o">();</span>

<span class="c1">// user-defined functions</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Messenger</span> <span class="kd">extends</span> <span class="n">GatherFunction</span> <span class="o">{...}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">VertexUpdater</span> <span class="kd">extends</span> <span class="n">ScatterFunction</span> <span class="o">{...}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">HashSet</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ScatterGatherConfiguration</span>

<span class="c1">// set the messaging direction</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setDirection</span><span class="o">(</span><span class="nc">EdgeDirection</span><span class="o">.</span><span class="nc">IN</span><span class="o">)</span>

<span class="c1">// run the scatter-gather iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runScatterGatherIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Messenger</span><span class="o">,</span> <span class="k">new</span> <span class="nc">VertexUpdater</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>
			<span class="o">.</span><span class="n">getVertices</span>

<span class="c1">// user-defined functions</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Messenger</span> <span class="k">extends</span> <span class="nc">ScatterFunction</span> <span class="o">{...}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">VertexUpdater</span> <span class="k">extends</span> <span class="nc">GatherFunction</span> <span class="o">{...}</span></code></pre></div>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="gather-sum-apply">Gather Sum Apply迭代计算</h2>
<p>就像Scatter Gather模型，Gather Sum Apply也在迭代步骤中同步执行，即超步。每个超步包含以下部分：</p>

<ul>
  <li><strong>Gather</strong>: 一个在边和对应顶点邻居上并行调用的UDF，产生一个局部值。</li>
  <li><strong>Sum</strong>: 用户定义的聚合函数，讲Gather产生的局部值合并为一个单一值。</li>
  <li><strong>Apply</strong>: 通过该函数将Sum产生的聚合值更新到每个顶点的当前值。</li>
</ul>

<p>让我们考虑使用GSA迭代模型计算单源点最短路径的算法（SSSP），下面的图中顶点1是原点。在<code>Gather</code>阶段，我们通过累加每个顶点的值和边的权值计算新的候选距离。在<code>Sum</code>阶段，候选距离通过顶点ID分组，并选择最小的距离。在<code>Apply</code>阶段，新计算出来的距离将会和当前顶点的值，二者之间的最小值将会被设为顶点的新值。</p>

<p class="text-center">
    <img alt="GSA SSSP superstep 1" width="70%" src="/1.2.0/fig/gelly-gsa-sssp1.png" />
</p>

<p>需要注意的是，如果顶点在超步中没有更新它的值，将不会在下次超步中计算候选距离。当没有顶点值发生更新时，算法收敛。</p>

<p>使用Gelly GSA实现该例子，用户只需要在输入图上调用<code>runGatherSumApplyIteration</code>方法，并提供<code>GatherFunction</code>，<code>SumFunction</code>和<code>ApplyFunction</code>用户定义函数。迭代的同步、分组、值更新和收敛由框架处理。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// read the input graph</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="kt">int</span> <span class="n">maxIterations</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="c1">// Execute the GSA iteration</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">runGatherSumApplyIteration</span><span class="o">(</span>
				<span class="k">new</span> <span class="nf">CalculateDistances</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">ChooseMinDistance</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">UpdateDistance</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">);</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">singleSourceShortestPaths</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getVertices</span><span class="o">();</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="c1">// Gather</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CalculateDistances</span> <span class="kd">extends</span> <span class="n">GatherFunction</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">Double</span> <span class="nf">gather</span><span class="o">(</span><span class="n">Neighbor</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">neighbor</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">neighbor</span><span class="o">.</span><span class="na">getNeighborValue</span><span class="o">()</span> <span class="o">+</span> <span class="n">neighbor</span><span class="o">.</span><span class="na">getEdgeValue</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Sum</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ChooseMinDistance</span> <span class="kd">extends</span> <span class="n">SumFunction</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">Double</span> <span class="nf">sum</span><span class="o">(</span><span class="n">Double</span> <span class="n">newValue</span><span class="o">,</span> <span class="n">Double</span> <span class="n">currentValue</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">newValue</span><span class="o">,</span> <span class="n">currentValue</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Apply</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">UpdateDistance</span> <span class="kd">extends</span> <span class="n">ApplyFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Double</span> <span class="n">newDistance</span><span class="o">,</span> <span class="n">Double</span> <span class="n">oldDistance</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">newDistance</span> <span class="o">&lt;</span> <span class="n">oldDistance</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setResult</span><span class="o">(</span><span class="n">newDistance</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// read the input graph</span>
<span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// define the maximum number of iterations</span>
<span class="k">val</span> <span class="n">maxIterations</span> <span class="k">=</span> <span class="mi">10</span>

<span class="c1">// Execute the GSA iteration</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runGatherSumApplyIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">CalculateDistances</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ChooseMinDistance</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UpdateDistance</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">)</span>

<span class="c1">// Extract the vertices as the result</span>
<span class="k">val</span> <span class="n">singleSourceShortestPaths</span> <span class="k">=</span> <span class="n">result</span><span class="o">.</span><span class="n">getVertices</span>


<span class="c1">// - - -  UDFs - - - //</span>

<span class="c1">// Gather</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">CalculateDistances</span> <span class="k">extends</span> <span class="nc">GatherFunction</span><span class="o">[</span><span class="kt">Double</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">gather</span><span class="o">(</span><span class="n">neighbor</span><span class="k">:</span> <span class="kt">Neighbor</span><span class="o">[</span><span class="kt">Double</span>, <span class="kt">Double</span><span class="o">])</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
		<span class="n">neighbor</span><span class="o">.</span><span class="n">getNeighborValue</span> <span class="o">+</span> <span class="n">neighbor</span><span class="o">.</span><span class="n">getEdgeValue</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Sum</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">ChooseMinDistance</span> <span class="k">extends</span> <span class="nc">SumFunction</span><span class="o">[</span><span class="kt">Double</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">sum</span><span class="o">(</span><span class="n">newValue</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">currentValue</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
		<span class="nc">Math</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="n">newValue</span><span class="o">,</span> <span class="n">currentValue</span><span class="o">)</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Apply</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">UpdateDistance</span> <span class="k">extends</span> <span class="nc">ApplyFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">newDistance</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">oldDistance</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">newDistance</span> <span class="o">&lt;</span> <span class="n">oldDistance</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setResult</span><span class="o">(</span><span class="n">newDistance</span><span class="o">)</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p>注意<code>gather</code>将<code>Neighbor</code>类型作为参数，这个方便的类型简单包装了顶点和它的邻边。</p>

<p>想要了解更多如何使用Gather Sum Apply模型实现算法，请查看<a href="https://github.com/apache/flink/blob/master//flink-libraries/flink-gelly/src/main/java/org/apache/flink/graph/library/GSAPageRank.java">GSAPageRank</a> and <a href="https://github.com/apache/flink/blob/master//flink-libraries/flink-gelly/src/main/java/org/apache/flink/graph/library/GSAConnectedComponents.java">GSAConnectedComponents</a>提供的Gelly库方法。</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="gather-sum-apply-1">Gather Sum Apply迭代计算配置</h2>

<p>GSA迭代计算可以通过<code>GSAConfiguration</code>对象进行配置。</p>

<p>目前以下参数可以被指定：</p>

<ul>
  <li>
    <p><strong>名称</strong>: GSA迭代计算的名称，该名称在日志和消息中显示，并可以使用<code>setName()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>并行度</strong>: 迭代计算的并行度，可以使用<code>setParallelism()</code>进行指定。</p>
  </li>
  <li>
    <p><strong>堆内Solution Set</strong>: 定义了Solution Set是否保存在堆内内存（Flink内部对象的序列化方式）中，还是保存在简单的对象表中。默认情况下，Solution Set保存在堆内内存中，该属性可以通过<code>setSolutionSetUnmanagedMemory()</code>方法进行设置。</p>
  </li>
  <li>
    <p><strong>聚合器</strong>: 迭代聚合器可以使用<code>registerAggregator()</code>方法进行注册，迭代聚合器可以将每次超步的聚合结果合并起来，并使得在下次超步中可以访问它们。注册后的聚合器可以在用户定义的<code>GatherFunction</code>，<code>SumFunction</code>和<code>ApplyFunction</code>的内部进行访问。</p>
  </li>
  <li>
    <p><strong>广播变量</strong>: 可以分别使用<code>addBroadcastSetForGatherFunction()</code>，<code>addBroadcastSetForSumFunction()</code>和<code>addBroadcastSetForApplyFunction</code>方法将数据集作为<a href="/1.2.0/dev/batch/index.html#broadcast-variables">广播变量</a>添加到<code>GatherFunction</code>，<code>SumFunction</code>和<code>ApplyFunction</code>。</p>
  </li>
  <li>
    <p><strong>顶点数</strong>: 允许迭代内部访问顶点总数，该属性可以通过<code>setOptNumVertices()</code>方法设置。</p>
  </li>
</ul>

<p>在gather，sum和apply函数内可以使用<code>getNumberOfVertices()</code>函数访问顶点数。如果该选型未设置，方法返回-1。</p>

<ul>
  <li><strong>边方向</strong>: 默认情况下会收集顶点输出邻居的值，该方向可以使用<code>setDirection()</code>修改。</li>
</ul>

<p>下面的例子展示了顶点数选项的使用。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">GSAConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GSAConfiguration</span><span class="o">();</span>

<span class="c1">// set the number of vertices option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setOptNumVertices</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="c1">// run the gather-sum-apply iteration, also passing the configuration parameters</span>
<span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">runGatherSumApplyIteration</span><span class="o">(</span>
				<span class="k">new</span> <span class="nf">Gather</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">Sum</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">Apply</span><span class="o">(),</span>
			    <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>

<span class="c1">// user-defined functions</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Gather</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// get the number of vertices</span>
	<span class="kt">long</span> <span class="n">numVertices</span> <span class="o">=</span> <span class="n">getNumberOfVertices</span><span class="o">();</span>
	<span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Sum</span> <span class="o">{</span>
	<span class="o">...</span>
    <span class="c1">// get the number of vertices</span>
    <span class="kt">long</span> <span class="n">numVertices</span> <span class="o">=</span> <span class="n">getNumberOfVertices</span><span class="o">();</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Apply</span> <span class="o">{</span>
	<span class="o">...</span>
    <span class="c1">// get the number of vertices</span>
    <span class="kt">long</span> <span class="n">numVertices</span> <span class="o">=</span> <span class="n">getNumberOfVertices</span><span class="o">();</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Double</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GSAConfiguration</span>

<span class="c1">// set the number of vertices option to true</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setOptNumVertices</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>

<span class="c1">// run the gather-sum-apply iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runGatherSumApplyIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Gather</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Sum</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Apply</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>

<span class="c1">// user-defined functions</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Gather</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="c1">// get the number of vertices</span>
	<span class="k">val</span> <span class="n">numVertices</span> <span class="k">=</span> <span class="n">getNumberOfVertices</span>
	<span class="o">...</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">Sum</span> <span class="o">{</span>
	<span class="o">...</span>
    <span class="c1">// get the number of vertices</span>
    <span class="k">val</span> <span class="n">numVertices</span> <span class="k">=</span> <span class="n">getNumberOfVertices</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">Apply</span> <span class="o">{</span>
	<span class="o">...</span>
    <span class="c1">// get the number of vertices</span>
    <span class="k">val</span> <span class="n">numVertices</span> <span class="k">=</span> <span class="n">getNumberOfVertices</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p>下面的例子展示了边方向选项的使用。</p>
<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Graph</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="n">GSAConfiguration</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GSAConfiguration</span><span class="o">();</span>

<span class="c1">// set the messaging direction</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">setDirection</span><span class="o">(</span><span class="n">EdgeDirection</span><span class="o">.</span><span class="na">IN</span><span class="o">);</span>

<span class="c1">// run the gather-sum-apply iteration, also passing the configuration parameters</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span>
			<span class="n">graph</span><span class="o">.</span><span class="na">runGatherSumApplyIteration</span><span class="o">(</span>
			<span class="k">new</span> <span class="nf">Gather</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">Sum</span><span class="o">(),</span> <span class="k">new</span> <span class="nf">Apply</span><span class="o">(),</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>
			<span class="o">.</span><span class="na">getVertices</span><span class="o">();</span></code></pre></div>

  </div>

  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">Graph</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">HashSet</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>, <span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// configure the iteration</span>
<span class="k">val</span> <span class="n">parameters</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GSAConfiguration</span>

<span class="c1">// set the messaging direction</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">setDirection</span><span class="o">(</span><span class="nc">EdgeDirection</span><span class="o">.</span><span class="nc">IN</span><span class="o">)</span>

<span class="c1">// run the gather-sum-apply iteration, also passing the configuration parameters</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">runGatherSumApplyIteration</span><span class="o">(</span><span class="k">new</span> <span class="nc">Gather</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Sum</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Apply</span><span class="o">,</span> <span class="n">maxIterations</span><span class="o">,</span> <span class="n">parameters</span><span class="o">)</span>
			<span class="o">.</span><span class="n">getVertices</span><span class="o">()</span></code></pre></div>

  </div>
</div>
<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="section">迭代计算抽象对比</h2>

<p>虽然Gelly提供的三种迭代计算抽象看起来很相似，然而理解它们之间的差别可以为程序提供更高的性能和可维护性。</p>

<p>以上三者之中，Vertex Centric模型是最通用的模型，并支持任意的计算和消息发送。Scatter Gather模型中，生产消息的逻辑和更顶点新的逻辑解耦。因此使用Scatter Gather模型开发的程序更容易跟进和维护。</p>

<p>将消息发送阶段和顶点更新逻辑分开，不仅让程序更容易跟进，更能对性能产生积极的影响。因为不需要同时访问存储接收消息和发送消息的数据结构，传统方式实现的Scatter Gather模型有更低的内存需求。然而，这个特性也限制了算法的表达能力，使得一些计算模式变得不够直观。自然地，如果一个算法需要顶点同时访问接收消息和发送消息的存储，那么使用Scatter Gather进行表示将会出现问题。强连通分量和近似最大权匹配算法就是类似的算法。这个限制的直接后果，就是顶点在同一个阶段中，无法既生成消息又更新状态。从而，要决定是否传播消息，就需要存储点的值，以便下一次迭代的gather阶段可以访问得到。如果顶点更新逻辑包含对邻边权值的计算，这就需要内部包含一个从scatter到gather阶段的特殊消息。因此，通常的解决办法将会导致更高的内存消耗，降低代码的优雅性，从而导致算法实现更难被理解。</p>

<p>GSA迭代模型和Scatter Gather模型也很相似。实际上，任何使用GSA表达的算法都可以使用Scatter Gather模型实现。Scatter Gather模型的消息发送阶段和GSA的Gather和Sum阶段等价：Gather可以被看作消息的生产阶段，Sum可以被看作消息路由到目标顶点的阶段。而顶点更新阶段和Apply步骤相对应。</p>

<p>二者实现的最主要的差别是GSA的Gather阶段是基于边的并行计算，而Scatter Gather的消息发送阶段是基于顶点的并行计算。结合上边SSSP的例子，我们可以看到在Scatter Gather例子的第一个超不中，顶点1、2、3并行产生消息，顶点1生产了3条消息，而顶点2和3各生产了一条消息。而在GSA的例子中，计算是基于边并行的：顶点1的三个候选的距离值是并行产生的。因此，如果Gather阶段包含了大量计算，使用GSA进行传播计算将是更好的方案，而不是加重一个顶点的计算。另外一种情况就是当输入图是倾斜（一些顶点相对于其他顶点拥有更多的邻居）的时候，基于边的并行计算会更加高效。</p>

<p>两者的另外一个区别就是Scatter Gather模型内部使用了<code>coGroup</code>，而GSA使用<code>reduce</code>进行计算。因此，如果计算中合并消息的函数需要全组的值，就应该使用Scatter Gather模型。如果更新函数是可结合、可交换的，那么GSA的聚合操作将是更高效的实现，因为它可以利用组合的特性。</p>

<p>另外需要注意的是，GSA需要严格地在邻居上执行，而Vertex Centric和Scatter Gather模型，顶点可以给任何已知ID的顶点发送消息，而不管这个顶点是否是自己的邻居。最后，在Gelly的Scatter Gather实现中，用户可以选择消息传播的方向，而GSA尚不能支持该特性，因此每个顶点只能基于它的输入邻居的值进行更新。</p>

<p>Gelly的迭代计算模型之间的主要差别如下表所示。</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th class="text-left" style="width: 25%">Iteration Model</th>
      <th class="text-center">Update Function</th>
      <th class="text-center">Update Logic</th>
      <th class="text-center">Communication Scope</th>
      <th class="text-center">Communication Logic</th>
    </tr>
  </thead>
  <tbody>
 <tr>
  <td>Vertex-Centric</td>
  <td>arbitrary</td>
  <td>arbitrary</td>
  <td>any vertex</td>
  <td>arbitrary</td>
</tr>
<tr>
  <td>Scatter-Gather</td>
  <td>arbitrary</td>
  <td>based on received messages</td>
  <td>any vertex</td>
  <td>based on vertex state</td>
</tr>
<tr>
  <td>Gather-Sum-Apply</td>
  <td>associative and commutative</td>
  <td>based on neighbors' values</td>
  <td>neighborhood</td>
  <td>based on vertex state</td>
</tr>
</tbody>
</table>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>


 <div class="footer">
  发现错误？想参与编辑？
  <a href="https://github.com/flink-china/flink-china-doc/edit/1.2.0/dev/libs/gelly/iterative_graph_processing.md" target="_blank">
    在 Github 上编辑此页！
  </a>
</div>

        </div>
      </div>
    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/1.2.0/page/js/flink.js"></script>

   <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>

    <!-- Disqus -->
    
  </body>
</html>
